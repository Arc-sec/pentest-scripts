#!/usr/bin/env python3

import sys
import os
import datetime
import argparse
import subprocess
from collections import Counter

subdomains_wordlist_ultra = f"/home/kali/Documents/Wordlist/httparchive_subdomains_2022_06_28.txt"
subdomains_wordlist_long = f"/usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt"
subdomains_wordlist_medium = f"/usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt"
subdomains_wordlist_short = f"/usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt"

wrong_subdomains = f"/home/kali/Documents/Wordlist/super_wrong_subdomains.txt"

directories_wordlist_long = f"/usr/share/seclists/Discovery/Web-Content/raft-large-directories-lowercase.txt"
directories_wordlist_medium = f"/usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt"
directories_wordlist_short = f"/usr/share/seclists/Discovery/Web-Content/raft-small-directories-lowercase.txt"

content_discovery_wordlist = f"/home/kali/Documents/Wordlist/Generic/content_discovery_all.txt"

scan_speed = 4
skip_port_discovery = " -Pn"

def print_message(message, color=None):
    # Function for printing messages with color support
    if color == "red":
        print(f"\033[31m{message}\033[0m")
    elif color == "green":
        print(f"\033[32m{message}\033[0m")
    elif color == "blue":
        print(f"\033[34m{message}\033[0m")
    else:
        print(message)

def usage():
    print_message("Usage:", "blue")
    print_message("---------------------------------------------------------------------", "blue")
    print_message("PasswordGenerator.py -ip               <ip-address>", "blue")
    print_message("PasswordGenerator.py -s                <step>", "blue")
    print_message("---------------------------------------------------------------------", "blue")
    sys.exit()

def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("-ip", "--ipaddress", help="Targets ip address")
    parser.add_argument("-s", "--step", help="Jump directly to specific enumeration step, 0=DNS, 1=PORTS, 2=SUBDOMAINS...")  

    return parser.parse_args()

def starting_tool_text(text):
    print_message(f"---               [Starting {text} enumeration]               ---", "green")

# Run linux commands in background, args = command
def run_command(command):
    print_message(f"[{command}]", "green")
    process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = process.communicate()
    if stderr.decode() != "":
        print_message(stderr.decode(), "red")
    else:
        print_message(stdout.decode(), "blue")

# Setup settings and folders for scripts
def run_script_setup(ip):
    print_message(f"---               [ Starting preparation steps ]               ---", "green")
    run_command(f"sudo sed -i '3s/.*/# /' /etc/hosts")
    run_command(f"mkdir '{ip}'; cd '{ip}'; mkdir nmap; mkdir subdomains; mkdir dns; mkdir ffuf; cd ..;")
    run_command(f"sudo chown kali: '{ip}' -R;")

# DNS
def start_dns_recon(ip):
    starting_tool_text('DNS')
    run_command(f"nslookup {ip} > '{ip}'/dns/nslookup.txt; cat '{ip}'/dns/nslookup.txt")
    run_command(f"dig {ip} > '{ip}'/dns/dig.txt; cat '{ip}'/dns/dig.txt")
    run_command(f"sudo sed -i '3s/.*/{ip}     ip-under-test.target/' /etc/hosts")

# PORTS
def start_port_recon(ip):
    starting_tool_text('PORT\'s')
    run_command(f"sudo nmap -sS -sV -sC{skip_port_discovery} -T{scan_speed} -g 80 {ip} -F -vv --reason -oA '{ip}'/nmap/1-initial-scan")
    run_command(f"sudo nmap -A{skip_port_discovery} -T{scan_speed} -g 80 -p- '{ip}' -oA '{ip}'/nmap/2-full-tcp-scan")
    run_command(f"sudo nmap -sV -sU{skip_port_discovery} -T{scan_speed} -g 53 --top-ports 250 -vv --reason '{ip}' -oA '{ip}'/nmap/3-full-udp-scan")

def extract_value(data_file_location):
    process = subprocess.Popen(data_file_location, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = process.communicate()

    # Extract values from output and count occurrences
    values = [int(line) for line in stdout.decode().split()]
    values_counter = Counter(values)
    return values_counter.most_common(1)[0][0]

# SUBDOMAIN
def start_subdomain_recon(ip):
    starting_tool_text('SUBDOMAIN\'s')
    run_command(f"ffuf -u http://ip-under-test.target/ -w {wrong_subdomains} -H 'Host:FUZZ.ip-under-test.target' -X POST > '{ip}'/ffuf/wrong.subdomains")
    run_command(f"grep -o 'Size: [^,]*' '{ip}'/ffuf/wrong.subdomains"" | awk '{print $2}' > "f"'{ip}'/ffuf/wrong.subdomains.size")
    run_command(f"grep -o 'Words: [^,]*' '{ip}'/ffuf/wrong.subdomains"" | awk '{print $2}' > "f"'{ip}'/ffuf/wrong.subdomains.words")
    run_command(f"grep -o 'Lines: [^,]*' '{ip}'/ffuf/wrong.subdomains"" | awk '{print $2}' > "f"'{ip}'/ffuf/wrong.subdomains.lines")
    
    resulting_size = extract_value(f"cat '{ip}'/ffuf/wrong.subdomains.size")
    resulting_words = extract_value(f"cat '{ip}'/ffuf/wrong.subdomains.words")
    resulting_lines = extract_value(f"cat '{ip}'/ffuf/wrong.subdomains.lines")

    # Find the most common value and print it
    print_message(f"size value is: {resulting_size}", "red")
    print_message(f"words value is: {resulting_words}", "red")
    print_message(f"lines value is: {resulting_lines}", "red")

    enumerate_subdomains(ip, resulting_size, resulting_words, resulting_lines, subdomains_wordlist_medium)
    #enumerate_subdomains(ip, resulting_size, resulting_words, resulting_lines, subdomains_wordlist_long)

# Enumerate SUBDOMAINS using MEDIUM wordlist
def enumerate_subdomains(ip, resulting_size, resulting_words, resulting_lines, wordlist):
    command = f"sudo ffuf -u http://ip-under-test.target/ -w {wordlist} -H 'Host:FUZZ.ip-under-test.target' -X POST -o '{ip}'/ffuf/subdomains.RESULT -mc all -fs {resulting_size} -fw {resulting_words} -fl {resulting_lines}"
    print_message(command, "red")
    
    os.system(command)

# DIRECTORIES
def start_directories_recon(ip):
    starting_tool_text('DIRECTORIES\'s')
    enumerate_directories(ip, content_discovery_wordlist)
    
    #command = f"sudo ffuf -u http://ip-under-test.target/FUZZ -w '{ip}'/ffuf/directories.BUFFER -o '{ip}'/ffuf/directories.RESULT -of all"
    #print_message(command, "red")
    
    #os.system(command)

# Enumerate SUBDOMAINS using MEDIUM wordlist
def enumerate_directories(ip, wordlist):
    command = f"sudo ffuf -u http://ip-under-test.target/FUZZ -w {wordlist} -recursion -recursion-depth 3 -o '{ip}'/ffuf/BUFFER -of all"
    print_message(command, "red")
    os.system(command)

    run_command(f"grep -o 'http*[^,]*' '{ip}'/ffuf/BUFFER.csv"" > "f"'{ip}'/ffuf/links.BUFFER")

# xxx
def start_all(ip):
    starting_tool_text('FILES\'s')

if __name__ == "__main__":
    args = parse_args()

    if args.ipaddress:
        print_message("Starting enumeration...", "green")
        
        if args.step == "0":
            run_script_setup(args.ipaddress)            

        if args.step == "1":
            start_dns_recon(args.ipaddress)

        if args.step == "2":
            start_port_recon(args.ipaddress)

        if args.step == "3":
            start_subdomain_recon(args.ipaddress)

        if args.step == "4":
            start_directories_recon(args.ipaddress)

        else:
            print_message("  --- --- ---  Starting full recon  --- --- --- ", "red")
            run_script_setup(args.ipaddress) 
            start_dns_recon(args.ipaddress)
            start_port_recon(args.ipaddress)
            start_subdomain_recon(args.ipaddress)
            start_directories_recon(args.ipaddress)


    if not any(vars(args).values()):
        print_message("Error: No arguments provided.", "red")
        usage()