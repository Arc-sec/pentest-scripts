#!/usr/bin/env python3

import sys
import os
import argparse
import subprocess
from collections import Counter

wrong_password_list = f"/home/kali/Documents/Wordlist/super_wrong_subdomains.txt"

def print_message(message, color=None):
    # Function for printing messages with color support
    if color == "red":
        print(f"\033[31m{message}\033[0m")
    elif color == "green":
        print(f"\033[32m{message}\033[0m")
    elif color == "blue":
        print(f"\033[34m{message}\033[0m")
    else:
        print(message)

def usage():
    print_message("Usage:", "blue")
    print_message("----------------------------------------------------------------------", "blue")
    print_message("sudo my.bruteforce -r -u -p", "blue")
    print_message("-r <request file>        REQUEST from BurpSuite saved in VS Code", "blue")
    print_message("-u <usernames file>      Usernames list", "blue")
    print_message("-p <passwords file>      Passwords list", "blue")
    print_message("----------------------------------------------------------------------", "blue")
    print_message("-request-proto the protocol to use", "blue")
    print_message("-mode clusterbomb use clusterbomb mode with the given inputs", "blue")
    print_message("-r follows redirects (need this for detection)", "blue")
    print_message("-v verbose (need this for detection)", "blue")
    print_message("----------------------------------------------------------------------", "blue")
    sys.exit()

def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("-r", "--request", help="Request from BURP")
    parser.add_argument("-u", "--username", help="Usernames list")
    parser.add_argument("-p", "--password", help="Passwords list")

    return parser.parse_args()

# Run linux commands in background, args = command
def run_command(command):
    print_message(f"[{command}]", "green")
    process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = process.communicate()
    if stderr.decode() != "":
        print_message(stderr.decode(), "red")
    else:
        print_message(stdout.decode(), "blue")

# Run linux commands in background, args = command
def run_command_silent(command):
    print_message(f"[{command}]", "red")
    process = subprocess.run(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)

# Detect wrong size
def detect_false_positives(request, username):
    command = f"ffuf -request {request} -request-proto http -mode clusterbomb -v -r -w {username}:FUZZUSER -w {wrong_password_list}:FUZZPASS -mc all"
    command += " -of csv > BUFFER"
    run_command_silent(command)
    run_command(f"grep -o 'Size: [^,]*' BUFFER"" | awk '{print $2}' > "f"BUFFER2.size")
    run_command(f"grep -o 'Words: [^,]*' BUFFER"" | awk '{print $2}' > "f"BUFFER2.words")
    run_command(f"grep -o 'Lines: [^,]*' BUFFER"" | awk '{print $2}' > "f"BUFFER2.lines")

def get_filter_size():
    return extract_value(f"cat BUFFER2.size")

def get_filter_words():
    return extract_value(f"cat BUFFER2.words")

def get_filter_lines():
    return extract_value(f"cat BUFFER2.lines")

def extract_value(data_file_location):
    process = subprocess.Popen(data_file_location, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = process.communicate()

    # Extract values from output and count occurrences
    values = [int(line) for line in stdout.decode().split()]
    values_counter = Counter(values)
    return values_counter.most_common(1)[0][0]

# Enumerate SUBDOMAINS using MEDIUM wordlist
def start(request, username, password):

    detect_false_positives(request, username)

    size = get_filter_size()
    words = get_filter_words()
    lines = get_filter_lines()

    run_cleanup()

    command = f"ffuf -request {request} -request-proto http -mode clusterbomb -v -r -w {username}:FUZZUSER -w {password}:FUZZPASS -o ffuf/bruteforce.result -of all -mc all -fs {size} -fw {words} -fl {lines}"    
    print_message(command, "red")
    os.system(command)

def run_cleanup():
    os.system("rm BUFFER2.words")
    os.system("rm BUFFER2.lines")
    os.system("rm BUFFER2.size")
    os.system("rm BUFFER")

if __name__ == "__main__":
    args = parse_args()

    print_message("Starting enumeration...", "green")
    print_message(f"request:  {args.request}", "blue")
    print_message(f"username:  {args.username}", "blue")
    print_message(f"password:  {args.password}", "blue")

    start(args.request, args.username, args.password)

    if not any(vars(args).values()):
        print_message("Error: No arguments provided.", "red")
        usage()